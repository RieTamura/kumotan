name: Feedback Integration

on:
  repository_dispatch:
    types: [feedback-received]
  issues:
    types: [closed]

jobs:
  create-issue:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create Feedback Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { type, word, expectation, comment, part_of_speech, post_url, row_index, logs, app_version, platform } = context.payload.client_payload;

            // タイプに応じたタイトル接頭辞
            const prefixes = {
              'bug': '【バグ報告】',
              'feature': '【機能提案】',
              'word_search': '【検索不具合】'
            };
            const prefix = prefixes[type] || '【フィードバック】';

            const title = `${prefix}${word}`;

            // Issue本文を構築
            const bodyLines = [
              `### 報告内容 (${type})`,
              `- **対象/件名**: ${word}`,
              `- **詳細/期待内容**: ${expectation || '未入力'}`,
            ];

            // word_searchタイプの場合は品詞・投稿リンクを追加
            if (type === 'word_search') {
              bodyLines.push(`- **品詞**: ${part_of_speech || '不明'}`);
              bodyLines.push(`- **投稿リンク**: ${post_url || 'なし'}`);
            }

            bodyLines.push(`- **コメント**: ${comment || 'なし'}`);

            // bugタイプの場合は環境情報・デバッグログを追加
            if (type === 'bug') {
              bodyLines.push(`- **アプリバージョン**: ${app_version || '不明'}`);
              bodyLines.push(`- **プラットフォーム**: ${platform || '不明'}`);
              if (logs) {
                bodyLines.push('');
                bodyLines.push('### デバッグログ');
                bodyLines.push('```');
                bodyLines.push(logs);
                bodyLines.push('```');
              }
            }

            // word_searchタイプの場合はレビューチェックリストを追加
            if (type === 'word_search') {
              bodyLines.push('');
              bodyLines.push('### レビューチェックリスト');
              bodyLines.push('- [ ] 他の辞書で意味を確認したか');
              bodyLines.push('  - https://kotobanomado.jp/');
              bodyLines.push('  - https://dictionary.cambridge.org/ja/');
              bodyLines.push('- [ ] 品詞・用途は正しいか');
              bodyLines.push('- [ ] 既存のoverridesに同じ単語の修正がないか');
              bodyLines.push('  - [overrides.json](https://rietamura.github.io/kumotan-dictionary/overrides.json) をブラウザで開き、対象の単語をページ内検索（Ctrl+F）で確認');
            }

            bodyLines.push('');
            bodyLines.push('---');
            bodyLines.push(`**ID (自動管理用)**: row_${row_index}`);
            bodyLines.push(`<!-- row_index: ${row_index} -->`);

            const body = bodyLines.join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: [type || 'feedback']
            });

  update-spreadsheet:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Update Spreadsheet Status
        shell: bash
        env:
          GAS_URL: ${{ secrets.FEEDBACK_GAS_URL }}
        run: |
          # Issueの本文から行番号を抽出
          BODY="${{ github.event.issue.body }}"
          ROW_INDEX=$(echo "$BODY" | grep -oP '<!-- row_index: \K\d+' || echo "")
          
          if [ -n "$ROW_INDEX" ]; then
            echo "Updating row $ROW_INDEX to Resolved..."
            curl -X POST -L "$GAS_URL" \
              -H "Content-Type: application/json" \
              -d "{\"action\": \"update_status\", \"row_index\": $ROW_INDEX}"
          else
            echo "No row_index found in issue body."
          fi
