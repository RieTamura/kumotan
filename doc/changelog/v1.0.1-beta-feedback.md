# v1.0.1 ベータフィードバック対応

**対応日**: 2026-01-15 〜 2026-01-19
**対応者**: Claude Code

## 概要

TestFlight配信後のベータテスターからのフィードバックに基づき、UIの改善を実施しました。

---

## 修正内容

### 1. WordPopupモーダルのキャンセルボタン透過問題

**報告内容**: ポップアップ画面のキャンセルボタンが透けている

**原因**：

1. アクションボタンエリアが`position: 'absolute'`で配置されていたが、`bottom: Spacing.xl`で隙間があった
2. キャンセルボタンの`outline`バリアントの`backgroundColor`が`'transparent'`（透明）だった
3. iOSのセーフエリア（ホームインジケーター）が未考慮だった

**修正ファイル**：

- `src/components/WordPopup/WordPopupModal.tsx`
- `src/components/common/Button.tsx`

**修正内容**：

**WordPopupModal.tsx** - アクションエリアのスタイル修正：
```typescript
// useSafeAreaInsetsをインポート
import { useSafeAreaInsets } from 'react-native-safe-area-context';

// コンポーネント内でセーフエリアを取得
const insets = useSafeAreaInsets();

// 動的にpaddingBottomを設定
<View style={[styles.actions, { paddingBottom: Math.max(insets.bottom, Spacing.lg) }]}>

// スタイル修正
actions: {
  flexDirection: 'row',
  paddingHorizontal: Spacing.xl,
  paddingTop: Spacing.lg,
  gap: Spacing.md,
  position: 'absolute',
  bottom: 0,  // Spacing.xl から 0 に変更
  left: 0,
  right: 0,
  backgroundColor: Colors.background,
  borderTopWidth: 1,  // 追加
  borderTopColor: Colors.divider,  // 追加
},

scrollContentContainer: {
  paddingBottom: 140,  // 100 から 140 に増加
},
```

2. **Button.tsx** - outlineバリアントの背景色修正:
```typescript
outline: {
  backgroundColor: Colors.background,  // 'transparent' から変更
  borderWidth: 1,
  borderColor: Colors.primary,
},
```

---

### 2. ライセンス画面のYahoo! API表示が縦書きになる問題

**報告内容**: Yahooのライセンス表示が縦書きになっている

**原因**： `licenseHeader`スタイルで`flexDirection: 'row'`を使用していた。`licenseName`が`flex: 1`で幅を取っていたため、長いテキストが縦に折り返されていた。

**修正ファイル**: `src/screens/LicenseScreen.tsx`

**修正内容**:
```typescript
licenseHeader: {
  flexDirection: 'column',  // 'row' から変更
  marginBottom: Spacing.xs,
  gap: Spacing.xs,
},
licenseName: {
  fontSize: FontSizes.md,
  fontWeight: '600',
  color: Colors.text,
  // flex: 1 を削除
},
licenseType: {
  // ... 既存のスタイル
  alignSelf: 'flex-start',  // 追加（バッジを左寄せ）
},
```

---

### 3. タブバーのラベル削除

**報告内容**: フッターメニューアイコン下の文字はいらないかも

**修正ファイル**: `src/navigation/AppNavigator.tsx`

**修正内容**:
- タブバーのラベル（「ホーム」「単語帳」「進捗」「設定」）を削除
- アイコンのみの表示に変更
- 不要になった`Text`、`FontSizes`インポートと`tabLabel`スタイルを削除
- `accessibilityLabel`はそのまま残し、スクリーンリーダーでのタブ名読み上げは維持

---

### 4. TOPへ戻るボタンの実装

**報告内容**: TOPへ戻るボタンを実装して欲しい

**修正ファイル**: `src/screens/HomeScreen.tsx`

**実装内容**:
- 500px以上スクロールすると右下にフローティングボタンを表示
- 上矢印アイコン（ArrowUp）を使用
- タップでフィードの先頭にスムーズスクロール
- フェードイン/フェードアウトのアニメーション付き
- プライマリカラー（青）の丸いボタン（48x48px）
- アクセシビリティラベル設定済み

**追加コード**:
```typescript
// State
const flatListRef = useRef<FlatList<TimelinePost>>(null);
const [showScrollToTop, setShowScrollToTop] = useState(false);
const scrollToTopOpacity = useRef(new Animated.Value(0)).current;
const SCROLL_THRESHOLD = 500;

// Handler
const handleScroll = useCallback(
  (event: NativeSyntheticEvent<NativeScrollEvent>) => {
    const offsetY = event.nativeEvent.contentOffset.y;
    const shouldShow = offsetY > SCROLL_THRESHOLD;
    // アニメーション処理...
  },
  [showScrollToTop, scrollToTopOpacity, SCROLL_THRESHOLD]
);

const scrollToTop = useCallback(() => {
  flatListRef.current?.scrollToOffset({ offset: 0, animated: true });
}, []);
```

**スタイル**:
```typescript
scrollToTopButton: {
  position: 'absolute',
  bottom: Spacing.xl,
  right: Spacing.lg,
  ...Shadows.md,
},
scrollToTopPressable: {
  width: 48,
  height: 48,
  borderRadius: 24,
  backgroundColor: Colors.primary,
  justifyContent: 'center',
  alignItems: 'center',
},
```

---

### 5. 多言語対応（i18n）の実装

**報告内容**: 国際化対応を実施

**実装内容**:

- `i18next`と`react-i18next`を使用した多言語対応基盤を構築
- 日本語（ja）と英語（en）の2言語をサポート
- デバイスの言語設定に応じて自動的に言語を切り替え

**追加ファイル**:

- `src/i18n/index.ts` - i18n設定と初期化
- `src/i18n/locales/en.json` - 英語翻訳ファイル
- `src/i18n/locales/ja.json` - 日本語翻訳ファイル

**対応画面**:

- ホーム画面（HomeScreen）
- 単語帳画面（WordbookScreen）
- 進捗画面（ProgressScreen）
- 設定画面（SettingsScreen）
- ライセンス画面（LicenseScreen）
- WordPopupモーダル
- その他共通コンポーネント

**使用方法**:

```typescript
import { useTranslation } from 'react-i18next';

const { t } = useTranslation();
// 使用例: t('home.title'), t('settings.language')
```

---

### 6. ATProtocol OAuth認証の正式実装

**目的**: `react-native-mmkv`などのネイティブモジュール依存によるエラーを解消し、安定したOAuth認証を提供。

**修正内容**:
- `@atproto/oauth-client`（コアライブラリ）への移行とカスタムアダプターの実装
- `react-native-mmkv`への依存を完全に排除し、`AsyncStorage`ベースのストレージアダプターを導入
- `expo-crypto`と`elliptic`を組み合わせたDPoP（Demonstrating Proof-of-Possession）対応の暗号化実装（`JoseKey`）
- `WebBrowser.openAuthSessionAsync`を使用した、より安定した認証フロー（ブラウザ起動からアプリ復旧までを一本化）
- 冗長なディープリンクリスナーの削除（コアライブラリとWebBrowserの組み合わせで簡素化）
- テストスイートの刷新：`authStore.test.ts`および`oauth-client`の初期化テストが正常に通過

---

### 7. ログイン画面の構成変更（OAuth一本化）

**目的**: ユーザー様のフィードバックに基づき、App Password認証を一旦廃止し、よりセキュアなOAuth認証のみのシンプルな構成に改善。

**修正ファイル**: `src/screens/LoginScreen.tsx`

**修正内容**:
- **App Password認証フォームの削除**: パスワード入力欄、ヘルプリンク、およびApp Password用のログインボタンを削除。
- **UIの簡素化**: ハンドル名入力と「Blueskyでログイン」ボタンのみの直感的なインターフェースに変更。
- **OAuthボタンのメイン化**: 画面中央に配置し、プライマリボタンとして設定。

---

### 8. OAuth認証エラー「Not implemented yet」の解消

**報告内容**: 実機（TestFlight）にてOAuth認証を試みると「Not implemented yet」エラーが発生する

**原因**:
- 暗号化の実装（`crypto-implementation.ts`）において、一部のバイナリ操作に環境依存（`atob`等）の関数を使用しており、Expo Go/Native環境で未実装エラーが発生していた。
- ダイジェスト（ハッシュ）計算時に、Uint8ArrayではなくBase64文字列を処理していたため計算結果が不正になっていた。
- `@atproto/oauth-client` が期待する `RuntimeImplementation` インターフェースのメソッド名が Core ライブラリのバージョンと乖離していた。

**修正ファイル**:
- `src/services/auth/crypto-implementation.ts`
- `src/services/auth/JoseKey.ts`

**修正内容**:
- **バイナリ処理の修正**: `expo-crypto` の `digest` メソッドを直接 Uint8Array で呼び出すように修正し、Base64/文字列変換によるバグと未実装エラーを解消。
- **インターフェースの適合**: インターフェース定義に合わせて `createKey` 等のメソッド名を修正。
- **鍵管理の強化**: `JoseKey` コンストラクタを拡張し、JWK（JSON Web Key）形式からの復元をサポートすることで、セッション再開時の安定性を向上。

---

### 9. OAuth認証後「Bad token scope」および「Authentication Required」エラーの解消

**報告内容**: OAuth認証自体は成功するが、認証後のAPI呼び出しで「Bad token scope」や「Authentication Required」エラーが発生する

**原因**:

1. **PDSとAuthorization Serverの混同**:
   - `bsky.social`はAuthorization Server（Entryway）であり、PDS（Protected Resource）ではない
   - ユーザーの実際のPDSは別のサーバー（例：`puffball.us-east.host.bsky.network`）
   - `customResolver`でハードコードされた`serviceEndpoint`が不正確だった

2. **DPoP-boundトークンとBskyAgentの非互換性**:
   - ATProtocol OAuthで取得するトークンはDPoP-bound（証明鍵に紐づけ）
   - `BskyAgent.resumeSession()`は従来のApp Password形式のトークンを想定
   - OAuth sessionの`fetchHandler`を使用してAPI呼び出しを行う必要があった

**修正ファイル**:
- `src/services/auth/oauth-client.ts`
- `src/services/bluesky/auth.ts`

**修正内容**:
- **PLC Directoryからの実DIDドキュメント取得**: `customResolver`を修正し、`https://plc.directory/{did}`からユーザーの本当のPDS URLを取得
- **キャッシュの修正**: Authorization Serverメタデータのみをキャッシュし、Protected Resourceキャッシュを削除
- **`setOAuthSession()`関数の導入**: OAuth sessionの`fetchHandler`を使用してAPI呼び出しを行うように変更
- **認証フローの修正**: `startOAuthFlow`と`resumeSession`で`setOAuthSession()`を使用

**成果**: **実機でのOAuthログイン成功を確認！**

---

### 10. 投稿フィードの翻訳漏れ修正

**報告内容**: 設定の言語を「English」にした時、投稿フィード内の以下の文章が英文に翻訳されていない
- 「たった今」等の投稿時間表示
- 「長押しで単語選択。ダブルタップで文章を選択 ※英文のみ」

**原因**: これらの文字列がハードコードされており、i18n翻訳システムを経由していなかった。

**修正ファイル**:
- `src/locales/en/common.json`
- `src/locales/ja/common.json`
- `src/locales/en/home.json`
- `src/locales/ja/home.json`
- `src/services/bluesky/feed.ts`
- `src/components/PostCard.tsx`

**修正内容**:

1. **相対時間の翻訳キー追加** (`common.json`):
```json
// en/common.json
"time": {
  "justNow": "Just now",
  "minutesAgo": "{{count}}m ago",
  "hoursAgo": "{{count}}h ago",
  "daysAgo": "{{count}}d ago"
}

// ja/common.json
"time": {
  "justNow": "たった今",
  "minutesAgo": "{{count}}分前",
  "hoursAgo": "{{count}}時間前",
  "daysAgo": "{{count}}日前"
}
```

2. **選択ヒントの翻訳キー追加** (`home.json`):
```json
// en/home.json
"selectionHint": "Long press to select word. Double tap to select sentence *English only"

// ja/home.json
"selectionHint": "長押しで単語選択。ダブルタップで文章を選択 ※英文のみ"
```

3. **`formatRelativeTime`関数の国際化対応** (`feed.ts`):
```typescript
export function formatRelativeTime(
  dateString: string,
  t?: TranslationFunction,
  locale: string = 'ja-JP'
): string {
  // 翻訳関数を受け取り、言語に応じた相対時間を返す
  if (diffSeconds < 60) {
    return t('common:time.justNow');
  } else if (diffMinutes < 60) {
    return t('common:time.minutesAgo', { count: diffMinutes });
  }
  // ...
}
```

4. **PostCardコンポーネントの更新** (`PostCard.tsx`):
```typescript
const { t, i18n } = useTranslation(['home', 'common']);

// 相対時間表示
{formatRelativeTime(post.createdAt, t, i18n.language)}

// 選択ヒント
{t('home:selectionHint')}
```

---

## テスト確認項目

- [ ] WordPopupモーダルのボタンエリアが透けていないこと
- [ ] ライセンス画面でYahoo! APIの名前とライセンスが正しく表示されること
- [ ] タブバーにアイコンのみ表示されること
- [ ] ホーム画面でスクロール後にTOPへ戻るボタンが表示されること
- [ ] TOPへ戻るボタンをタップでフィード先頭に戻ること
- [ ] **ログイン画面がハンドル名とOAuthボタンのみになっていること**
- [ ] **実機で「Blueskyでログイン」をタップし、正常に認証ブラウザが起動すること**
- [ ] **認証完了後、アプリに正常に戻りログインができること**
- [ ] **設定で言語を「English」に変更後、投稿時間が英語表示（"Just now", "5m ago"等）になること**
- [ ] **設定で言語を「English」に変更後、選択ヒントが英語表示になること**
- [ ] **句読点のない英語投稿で単語のダブルタップ・長押しが動作すること**
- [ ] **いいねボタンの隣にBookSearchアイコンが表示されること**
- [ ] **BookSearchアイコンをタップすると投稿全体でWordPopupが開くこと**

---

### 11. 句読点なしの英文選択対応 & BookSearchボタン追加

**報告内容**:
- SNSの投稿はピリオド(.)や句読点(。)がない場合が多く、文章選択ができない
- ダブルタップは疲れるため、ワンタップで投稿全体を調べられるボタンが欲しい

**原因**:
- `PostCard.tsx`の英文判定ロジックで、末尾に`.!?`がないと英文として認識されなかった
- `splitIntoSentences()`は句読点なしのテキストを返すが、`isEnglishSentence`チェックで弾かれていた

**修正ファイル**:
- `src/components/PostCard.tsx`
- `src/locales/en/home.json`
- `src/locales/ja/home.json`

**修正内容**:

1. **句読点なしの英文選択対応** (`PostCard.tsx` 78-83行目):
```typescript
// 変更前
const hasEnglish = /[a-zA-Z]/.test(sentence);
const isEnglishSentence = hasEnglish && /[.!?]$/.test(sentence.trim());

// 変更後
const hasEnglish = /[a-zA-Z]/.test(sentence);
const hasTerminalPunctuation = /[.!?]$/.test(sentence.trim());
// 句読点がない場合でも、単一文章なら英文として扱う
const isOnlySentence = sentences.length === 1;
const isEnglishSentence = hasEnglish && (hasTerminalPunctuation || isOnlySentence);
```

2. **BookSearchボタンの追加** (`PostCard.tsx`):
```typescript
// アイコンのインポート追加
import { MessageCircle, Repeat2, Heart, BookSearch } from 'lucide-react-native';

// ハンドラー追加
const handleBookSearchPress = useCallback(() => {
  if (!onSentenceSelect) return;
  const fullText = post.text.trim();
  if (fullText) {
    setSelectedSentence(fullText);
    setSelectedWord(null);
    onSentenceSelect(fullText, post.uri, post.text);
  }
}, [post.uri, post.text, onSentenceSelect]);

// UIにボタン追加（いいねボタンの隣）
{onSentenceSelect && (
  <Pressable
    style={styles.bookSearchButton}
    onPress={handleBookSearchPress}
    hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
    accessible={true}
    accessibilityLabel={t('home:lookupPost')}
    accessibilityRole="button"
  >
    <BookSearch size={16} color={Colors.textSecondary} />
  </Pressable>
)}

// スタイル追加
bookSearchButton: {
  flexDirection: 'row',
  alignItems: 'center',
  padding: Spacing.xs,
},
```

3. **翻訳キーの追加**:
```json
// en/home.json
"lookupPost": "Look up post"

// ja/home.json
"lookupPost": "投稿を調べる"
```

**効果**:
- "oh yeah that would sell" のような句読点なしの投稿でも単語選択・文章選択が可能に
- BookSearchアイコンをワンタップするだけで投稿全体をWordPopupで調べられる

---

## 次のステップ

1. 新しいビルドを作成（`eas build --profile production --platform ios`）
2. TestFlightに配信
3. ベータテスターに再テストを依頼
