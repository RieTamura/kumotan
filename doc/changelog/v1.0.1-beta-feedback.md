# v1.0.1 ベータフィードバック対応

**対応日**: 2026-01-15
**対応者**: Claude Code

## 概要

TestFlight配信後のベータテスターからのフィードバックに基づき、UIの改善を実施しました。

---

## 修正内容

### 1. WordPopupモーダルのキャンセルボタン透過問題

**報告内容**: ポップアップ画面のキャンセルボタンが透けている

**原因**: アクションボタンエリアが`position: 'absolute'`で配置されていたが、背景色が未設定だったため、スクロールコンテンツが透けて見えていた。

**修正ファイル**: `src/components/WordPopup/WordPopupModal.tsx`

**修正内容**:
```typescript
actions: {
  // ... 既存のスタイル
  backgroundColor: Colors.background,  // 追加
},
```

---

### 2. ライセンス画面のYahoo! API表示が縦書きになる問題

**報告内容**: Yahooのライセンス表示が縦書きになっている

**原因**: `licenseHeader`スタイルで`flexDirection: 'row'`を使用し、`licenseName`が`flex: 1`で幅を取っていたため、長いライセンステキストが横幅不足で縦に折り返されていた。

**修正ファイル**: `src/screens/LicenseScreen.tsx`

**修正内容**:
```typescript
licenseHeader: {
  flexDirection: 'column',  // 'row' から変更
  marginBottom: Spacing.xs,
  gap: Spacing.xs,
},
licenseName: {
  fontSize: FontSizes.md,
  fontWeight: '600',
  color: Colors.text,
  // flex: 1 を削除
},
licenseType: {
  // ... 既存のスタイル
  alignSelf: 'flex-start',  // 追加（バッジを左寄せ）
},
```

---

### 3. タブバーのラベル削除

**報告内容**: フッターメニューアイコン下の文字はいらないかも

**修正ファイル**: `src/navigation/AppNavigator.tsx`

**修正内容**:
- タブバーのラベル（「ホーム」「単語帳」「進捗」「設定」）を削除
- アイコンのみの表示に変更
- 不要になった`Text`、`FontSizes`インポートと`tabLabel`スタイルを削除
- `accessibilityLabel`はそのまま残し、スクリーンリーダーでのタブ名読み上げは維持

---

### 4. TOPへ戻るボタンの実装

**報告内容**: TOPへ戻るボタンを実装して欲しい

**修正ファイル**: `src/screens/HomeScreen.tsx`

**実装内容**:
- 500px以上スクロールすると右下にフローティングボタンを表示
- 上矢印アイコン（ArrowUp）を使用
- タップでフィードの先頭にスムーズスクロール
- フェードイン/フェードアウトのアニメーション付き
- プライマリカラー（青）の丸いボタン（48x48px）
- アクセシビリティラベル設定済み

**追加コード**:
```typescript
// State
const flatListRef = useRef<FlatList<TimelinePost>>(null);
const [showScrollToTop, setShowScrollToTop] = useState(false);
const scrollToTopOpacity = useRef(new Animated.Value(0)).current;
const SCROLL_THRESHOLD = 500;

// Handler
const handleScroll = useCallback(
  (event: NativeSyntheticEvent<NativeScrollEvent>) => {
    const offsetY = event.nativeEvent.contentOffset.y;
    const shouldShow = offsetY > SCROLL_THRESHOLD;
    // アニメーション処理...
  },
  [showScrollToTop, scrollToTopOpacity, SCROLL_THRESHOLD]
);

const scrollToTop = useCallback(() => {
  flatListRef.current?.scrollToOffset({ offset: 0, animated: true });
}, []);
```

**スタイル**:
```typescript
scrollToTopButton: {
  position: 'absolute',
  bottom: Spacing.xl,
  right: Spacing.lg,
  ...Shadows.md,
},
scrollToTopPressable: {
  width: 48,
  height: 48,
  borderRadius: 24,
  backgroundColor: Colors.primary,
  justifyContent: 'center',
  alignItems: 'center',
},
```

---

### 5. 多言語対応（i18n）の実装

**報告内容**: 国際化対応を実施

**実装内容**:

- `i18next`と`react-i18next`を使用した多言語対応基盤を構築
- 日本語（ja）と英語（en）の2言語をサポート
- デバイスの言語設定に応じて自動的に言語を切り替え

**追加ファイル**:

- `src/i18n/index.ts` - i18n設定と初期化
- `src/i18n/locales/en.json` - 英語翻訳ファイル
- `src/i18n/locales/ja.json` - 日本語翻訳ファイル

**対応画面**:

- ホーム画面（HomeScreen）
- 単語帳画面（WordbookScreen）
- 進捗画面（ProgressScreen）
- 設定画面（SettingsScreen）
- ライセンス画面（LicenseScreen）
- WordPopupモーダル
- その他共通コンポーネント

**使用方法**:

```typescript
import { useTranslation } from 'react-i18next';

const { t } = useTranslation();
// 使用例: t('home.title'), t('settings.language')
```

---

### 6. ATProtocol OAuth認証の正式実装

**目的**: `react-native-mmkv`などのネイティブモジュール依存によるエラーを解消し、安定したOAuth認証を提供。

**修正内容**:
- `@atproto/oauth-client`（コアライブラリ）への移行とカスタムアダプターの実装
- `react-native-mmkv`への依存を完全に排除し、`AsyncStorage`ベースのストレージアダプターを導入
- `expo-crypto`と`elliptic`を組み合わせたDPoP（Demonstrating Proof-of-Possession）対応の暗号化実装（`JoseKey`）
- `WebBrowser.openAuthSessionAsync`を使用した、より安定した認証フロー（ブラウザ起動からアプリ復旧までを一本化）
- 冗長なディープリンクリスナーの削除（コアライブラリとWebBrowserの組み合わせで簡素化）
- テストスイートの刷新：`authStore.test.ts`および`oauth-client`の初期化テストが正常に通過

---

### 7. ログイン画面の構成変更（OAuth一本化）

**目的**: ユーザー様のフィードバックに基づき、App Password認証を一旦廃止し、よりセキュアなOAuth認証のみのシンプルな構成に改善。

**修正ファイル**: `src/screens/LoginScreen.tsx`

**修正内容**:
- **App Password認証フォームの削除**: パスワード入力欄、ヘルプリンク、およびApp Password用のログインボタンを削除。
- **UIの簡素化**: ハンドル名入力と「Blueskyでログイン」ボタンのみの直感的なインターフェースに変更。
- **OAuthボタンのメイン化**: 画面中央に配置し、プライマリボタンとして設定。

---

### 8. OAuth認証エラー「Not implemented yet」の解消

**報告内容**: 実機（TestFlight）にてOAuth認証を試みると「Not implemented yet」エラーが発生する

**原因**: 
- 暗号化の実装（`crypto-implementation.ts`）において、一部のバイナリ操作に環境依存（`atob`等）の関数を使用しており、Expo Go/Native環境で未実装エラーが発生していた。
- ダイジェスト（ハッシュ）計算時に、Uint8ArrayではなくBase64文字列を処理していたため計算結果が不正になっていた。
- `@atproto/oauth-client` が期待する `RuntimeImplementation` インターフェースのメソッド名が Core ライブラリのバージョンと乖離していた。

**修正ファイル**: 
- `src/services/auth/crypto-implementation.ts`
- `src/services/auth/JoseKey.ts`

**修正内容**:
- **バイナリ処理の修正**: `expo-crypto` の `digest` メソッドを直接 Uint8Array で呼び出すように修正し、Base64/文字列変換によるバグと未実装エラーを解消。
- **インターフェースの適合**: インターフェース定義に合わせて `createKey` 等のメソッド名を修正。
- **鍵管理の強化**: `JoseKey` コンストラクタを拡張し、JWK（JSON Web Key）形式からの復元をサポートすることで、セッション再開時の安定性を向上。

---

## テスト確認項目

- [ ] WordPopupモーダルのボタンエリアが透けていないこと
- [ ] ライセンス画面でYahoo! APIの名前とライセンスが正しく表示されること
- [ ] タブバーにアイコンのみ表示されること
- [ ] ホーム画面でスクロール後にTOPへ戻るボタンが表示されること
- [ ] TOPへ戻るボタンをタップでフィード先頭に戻ること
- [ ] **ログイン画面がハンドル名とOAuthボタンのみになっていること**
- [ ] **実機で「Blueskyでログイン」をタップし、正常に認証ブラウザが起動すること**
- [ ] **認証完了後、アプリに正常に戻りログインができること**

---

## 次のステップ

1. 新しいビルドを作成（`eas build --profile production --platform ios`）
2. TestFlightに配信
3. ベータテスターに再テストを依頼
